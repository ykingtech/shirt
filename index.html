<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Shirt Editor (PSD Style)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overflow: hidden; background: #f3f4f6; }
        /* Editor Canvas Style */
        .canvas-container { background-image: url('https://img.freepik.com/free-vector/gray-grid-mosaic-background_53876-118281.jpg'); background-size: cover; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="flex h-screen text-gray-800">

    <div class="w-1/2 flex flex-col p-4 bg-white shadow-xl z-10">
        <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
            <span class="text-indigo-600">DESIGN</span> AREA
        </h2>

        <div class="flex gap-2 mb-4 flex-wrap">
            <button onclick="addText()" class="bg-gray-800 text-white px-4 py-2 rounded font-bold text-sm hover:bg-black">+ Add Text</button>
            <label class="bg-indigo-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-indigo-700 cursor-pointer">
                + Upload Image
                <input type="file" id="imgLoader" accept="image/*" class="hidden">
            </label>
            <button onclick="deleteObject()" class="bg-red-500 text-white px-4 py-2 rounded font-bold text-sm hover:bg-red-600">Delete Selected</button>
            <input type="color" id="tshirtColor" value="#ffffff" oninput="changeShirtColor(this.value)" class="h-10 w-10 cursor-pointer border rounded" title="Shirt Color">
        </div>

        <div class="flex-1 flex items-center justify-center bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl relative">
            <p class="absolute top-2 text-xs text-gray-400 font-bold">PRINT AREA (Dragging Zone)</p>
            <canvas id="c" width="400" height="500"></canvas>
        </div>
        
        <p class="text-xs text-gray-500 mt-2 text-center">Drag, Rotate & Resize items inside the box.</p>
    </div>

    <div id="3d-view" class="w-1/2 bg-gray-200 relative">
        <div id="loader" class="absolute inset-0 flex items-center justify-center text-gray-500 font-bold">
            Loading 3D Model...
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        // ==========================================
        // PART 1: FABRIC.JS (THE 2D EDITOR)
        // ==========================================
        const canvas = new fabric.Canvas('c');
        
        // Add a placeholder text on load
        const text = new fabric.Text('YOUR BRAND', {
            left: 100, top: 200, fontFamily: 'Arial', fill: '#000', fontSize: 40
        });
        canvas.add(text);

        // Update 3D texture whenever 2D canvas changes
        canvas.on('after:render', function() {
            if(textureMesh && textureMesh.material.map) {
                textureMesh.material.map.needsUpdate = true;
            }
        });

        // --- 2D Functions ---
        function addText() {
            const t = new fabric.IText('New Text', {
                left: 50, top: 50, fontFamily: 'Arial', fill: '#000', fontSize: 30
            });
            canvas.add(t);
            canvas.setActiveObject(t);
        }

        document.getElementById('imgLoader').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function() {
                    const imgInstance = new fabric.Image(imgObj);
                    imgInstance.scaleToWidth(200);
                    canvas.add(imgInstance);
                    canvas.centerObject(imgInstance);
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        function deleteObject() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                canvas.remove(activeObj);
            }
        }

        // ==========================================
        // PART 2: THREE.JS (THE 3D PREVIEW)
        // ==========================================
        let scene, camera, renderer, shirtMesh, textureMesh;
        
        function init3D() {
            const container = document.getElementById('3d-view');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe5e7eb);

            // Camera
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 0, 2.5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const spot = new THREE.DirectionalLight(0xffffff, 0.8);
            spot.position.set(2, 5, 5);
            spot.castShadow = true;
            scene.add(spot);

            // --- THE MAGIC: Create Texture from Fabric Canvas ---
            const canvasTexture = new THREE.CanvasTexture(document.getElementById('c'));
            canvasTexture.anisotropy = renderer.capabilities.getMaxAnisotropy();
            // Note: Fabric canvas might be transparent, so we handle that in material

            // Load Shirt Model
            const loader = new THREE.GLTFLoader();
            loader.load('shirt.glb', function(gltf) {
                shirtMesh = gltf.scene;

                // Auto-Center & Scale Logic
                const box = new THREE.Box3().setFromObject(shirtMesh);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                shirtMesh.position.x += (shirtMesh.position.x - center.x);
                shirtMesh.position.y += (shirtMesh.position.y - center.y);
                shirtMesh.position.z += (shirtMesh.position.z - center.z);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 1.5 / maxDim;
                shirtMesh.scale.set(scale, scale, scale);

                // Apply Base Material
                shirtMesh.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.material = new THREE.MeshStandardMaterial({
                            color: 0xffffff, roughness: 0.6
                        });
                    }
                });

                scene.add(shirtMesh);
                document.getElementById('loader').style.display = 'none';

                // --- ADD PRINT AREA (The Decal Plane) ---
                // Instead of a small decal, we create a large "Print Area" plane
                // that maps to the canvas size.
                const planeGeo = new THREE.PlaneGeometry(0.8, 1.0); // Size of the print area on chest
                const planeMat = new THREE.MeshBasicMaterial({
                    map: canvasTexture,
                    transparent: true,
                    depthWrite: false, // Prevents Z-fighting
                    polygonOffset: true,
                    polygonOffsetFactor: -4
                });

                textureMesh = new THREE.Mesh(planeGeo, planeMat);
                textureMesh.position.set(0, 0.1, 0.35); // Position on chest (Adjust Z if hidden)
                scene.add(textureMesh);

            });

            // Controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Render Loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
                
                // IMPORTANT: Tell Three.js texture has changed
                if(textureMesh && textureMesh.material.map) {
                   textureMesh.material.map.needsUpdate = true;
                }
            }
            animate();
            
            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        // Change Shirt Base Color
        window.changeShirtColor = function(color) {
            if(shirtMesh) {
                shirtMesh.traverse((child) => {
                    if(child.isMesh) child.material.color.set(color);
                });
            }
        }

        // Start
        init3D();

    </script>
</body>
</html>
